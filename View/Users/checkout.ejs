<style>
    .modal {
    z-index: 1050;
}
    .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .modal-title {
        font-weight: bold;
    }

    .modal-body {
        font-size: 0.9rem;
    }

    .modal-body h6 {
        font-size: 1rem;
        font-weight: bold;
    }

    .modal-body p {
        margin-bottom: 0.5rem;
    }

    .table {
        margin-bottom: 0;
    }

    .table thead th {
        background-color: #f8f9fa;
    }

    .table tfoot th {
        background-color: #f8f9fa;
        font-weight: bold;
    }

    .modal-footer {
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }
</style>

<%- include('./layout/header.ejs') %>
<!--::header part start::-->
<%- include('./layout/navbar.ejs') %>
<!-- Header part end-->

<!-- breadcrumb part start-->
<section class="breadcrumb_part" style="height: 100px;">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb_iner">
                    <h2 id="RvText">Checkout</h2>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- breadcrumb part end-->

<!--================Checkout Area =================-->
<section class="checkout_area section_padding" >
    <div class="container" style="margin-top: -150px;">
        <div class="cupon_area">
            <div class="check_title">
                <h2>Have a coupon? Enter your code</h2>
            </div>
            <input type="text" placeholder="Enter coupon code"/>
            <a class="tp_btn" href="#">Apply Coupon</a>
        </div>
        <hr>
        <div class="billing_details">
            <div class="row">
                <div class="col-lg-8">
                    <h1>ADDRESS DETAILS</h1>
                    <section class="user_addresses">
                        <h3>Available Addresses:</h3>
                      <% if(typeof userAddresses != 'undefined'){ %>
                            <form id="addressForm" action="/checkout" method="post">
                                <% userAddresses.forEach(function(address) { %>
                                    <div class="info-box">
                                        <div class="Check-info-header">
                                            <div class="Check-radio-input">
                                                <input type="radio" id="<%= address.Code %>" name="address" value="<%= address.Code %>" required>
                                                <div class="Check-circle"></div>
                                            </div>
                                            <span id="nameB" ><%= address.Bname %></span>
                                            <span class="Check-arrow"></span>
                                        </div>
                                        <div class="Check-info-content">
                                            <h6>Name: <%= address.name %></h6>
                                            <h6>Phone: <%= address.phone %></h6>
                                            <h6>Email: <%= address.email %></h6>
                                            <h6>Address: <%= address.address %></h6>
                                            <h6>City: <%= address.town %></h6>
                                            <h6>Pincode: <%= address.pincode %></h6>
                                        </div>
                                    </div>
                                    <br>
                                <% }); %>
                            </form>
                        <% }else{ %>
                              <h3>You don't have address</h3>
                           <% } %> 
                        <hr>
                        <h1>Add new Address</h1>
                        <button id="addAddressButton" class="btn_3">Add Address</button>
                        <br>
                        <hr>
                        <div class="address_form_fields" style="display: none;">
                            <h3>Add New Address:</h3>
                            <form id="newAddressForm">
                                <div class="col-md-12 form-group">
                                    <span style="margin-left: 10px;">Name</span>
                                    <input type="text" class="form-control" id="name" name="name" required/>
                                </div>
                                <div class="col-md-12 form-group">
                                    <span style="margin-left: 10px;">Work or Home</span>
                                    <input type="text" class="form-control" id="Bname" name="Bname" required/>
                                </div>
                                <div class="col-md-12 form-group">
                                    <span style="margin-left: 10px;">phone</span>
                                    <input type="number" class="form-control" id="phone" name="phone" required/>
                                </div>
                                <div class="col-md-12 form-group">
                                    <span style="margin-left: 10px;">email</span>
                                    <input type="text" class="form-control" id="email" name="email" required/>
                                </div>
                                <div class="col-md-12 form-group">
                                    <span style="margin-left: 10px;">address</span>
                                    <input type="text" class="form-control" id="address" name="address" required/>
                                </div>
                                <div class="col-md-12 form-group">
                                    <span style="margin-left: 10px;">city</span>
                                    <input type="text" class="form-control" id="city" name="city"  required/>
                                </div>
                                <div class="col-md-12 form-group">
                                    <span style="margin-left: 10px;">pincode</span>
                                    <input type="number" class="form-control" id="pincode" name="pincode" required/>
                                </div>

                                <button  class="col-md-12 form-group" id="saveAddressButton" style="border-radius: 6px; height: 40px; margin-left: 10px;">Save Address</button>
                            </form>
                        </div>
                    </section>
                    <h3>Select Payment Method:</h3>
                    <div class="Check-radio-input">
                        <input type="radio" id="cash" name="payment_method" value="CashOnDelivery" required>
                        <div class="Check-circle"></div>
                        <label for="cash">Cash On Delivery</label>
                    </div>
                    <br>
                    <div class="Check-radio-input">
                        <input  type="radio" id="Razorpay" name="payment_method" value="Razorpay" required>
                        <div class="Check-circle"></div>
                        <label for="cash">Razorpay</label>
                    </div>
                    <br>
                    <button id="proceedButton" class="btn_3" type="button" onclick="proceed()">Click to Proceed</button>
                </div>
                <div class="col-lg-4">
                    <div class="order_box">
                        <h2>Your Order Details</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th style="padding: 10px;">Quantity</th>
                                    <th style="padding: 10px;">Product</th>
                                    <th style="padding: 10px;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% let subtotal = 0; %>
                                <% Products.forEach(function(productDetails, index) { %>
                                    <tr>
                                        <td style="padding: 10px;"><%= productDetails[1] %></td>
                                        <td style="padding: 10px;"><%= productDetails[0].productTitle %></td>        
                                        <td style="padding: 10px;">$ <%= productDetails[0].price * productDetails[1] %></td>
                                        <input type="hidden" name="productId" value="<%= productDetails[0]._id %>">
                                    </tr>
                                
                                    <% subtotal += productDetails[0].price * productDetails[1]; %>
                                <% }); %>
                            </tbody>
                        </table>
                        <hr>
                        <span>Subtotal :</span>
                        <span style="margin-left: 170px;">$ <%= subtotal %></span>
                        <input type="hidden" id="subtotal" value="<%= subtotal %>" >
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!--================End Checkout Area =================-->


 <!-- Order Confirmation Modal -->
<div class="modal fade" id="orderConfirmationModal" tabindex="-1" aria-labelledby="orderConfirmationModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderConfirmationModalLabel">Order Confirmation</h5>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6>Order Details</h6>
                            <p><strong>Order Number:</strong> <span id="orderNumber"></span></p>
                            <p><strong>Order Date:</strong> <span id="orderDate"></span></p>
                            <p><strong>Order Total:</strong> <span id="orderTotal"></span></p>
                            <p><strong>Payment Method:</strong> <span id="paymentMethod"></span></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6>Billing Address</h6>
                            <p><strong>Billing Address:</strong> <span id="billingAddress" ></span></p>
                            <p><strong>Billing City:</strong> <span id="billingCity"    ></span></p>
                            <p><strong>Billing Phone:</strong> <span id="billingPhone"   ></span></p>
                            <p><strong>Billing Postcode:</strong> <span id="billingPostcode"></span></p>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <h6>Order Items</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th colspan="2">Product</th>
                                            <th>Quantity</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="orderDetailsTableBody">
                                        <!-- Order items will be populated here -->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <th colspan="3" class="text-right">Subtotal</th>
                                            <th id="modalSubtotal"></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <h2 style="margin-right: 170px;">Thank You For Ordering</h2>
                <button type="button" class="btn btn-secondary" id="closeMOdal">Close</button>
            </div>
        </div>
    </div>
</div>

<!--::footer_part start::-->
<footer class="footer_part">
    <div class="footer_iner section_bg">
        <div class="container">
            <div class="row justify-content-between align-items-center">
                <div class="col-lg-8">
                    <div class="footer_menu">
                        <div class="footer_logo">
                            <a href="index.html"><img src="img/logo.png" alt="#"></a>
                        </div>
                        <div class="footer_menu_item">
                            <a href="index.html">Home</a>
                            <a href="about.html">About</a>
                            <a href="product_list.html">Products</a>
                            <a href="#">Pages</a>
                            <a href="blog.html">Blog</a>
                            <a href="contact.html">Contact</a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="social_icon">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-google-plus-g"></i></a>
                        <a href="#"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="copyright_part">
        <div class="container">
            <div class="row ">
                <div class="col-lg-12">
                    <div class="copyright_text">
                        <P>Copyright &copy;<script>document.write(new Date().getFullYear());</script>
                            All rights reserved | This template is made with <i class="ti-heart" aria-hidden="true"></i> by <a
                                href="https://colorlib.com" target="_blank">Colorlib</a>
                        </P>
                        <div class="copyright_link">
                            <a href="#">Terms & Conditions</a>
                            <a href="#">FAQ</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</footer>
<!--::footer_part end::-->

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>

<link rel="stylesheet" href="/node_modules/sweetalert2/dist/sweetalert2.min.css">
<script src="/node_modules/sweetalert2/dist/sweetalert2.all.min.js"></script>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
     var notyf = new Notyf();
    document.getElementById('addAddressButton').addEventListener('click', function() {
        document.querySelector('.address_form_fields').style.display = 'block';
    });

    function proceed(){
    const selectedAddress = document.querySelector('input[name="address"]:checked');
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
    const subtotal = document.getElementById('subtotal').value;

    if(selectedAddress){
        if(paymentMethod){
         const navv = document.getElementById("navv").style.display = 'none';
          
                    Swal.fire({
                      title: "Are you sure?",
                      icon: "question",
                      showCancelButton: true,
                      confirmButtonColor: "#3085d6",
                      cancelButtonColor: "#d33",
                      confirmButtonText: "Yes, Order it!"
                          }).then((result) => {
                            if (result.isConfirmed){

                    const addressCode = selectedAddress.value;
                    const orderDetails = [];
                    const tableRows = document.querySelectorAll('.order_box table tbody tr');
                    const productIds = [];
                    
                    document.querySelectorAll('input[name="productId"]').forEach(input => {
                        productIds.push(input.value);
                    });

                    tableRows.forEach(row =>{
                        const quantity = row.children[0].innerText;
                        const productTitle = row.children[1].innerText;
                        const total = row.children[2].innerText;
                        const productId = row.querySelector('input[name="productId"]').value;

                        orderDetails.push({
                            quantity: parseInt(quantity),
                            productTitle: productTitle,
                            total: parseFloat(total.replace('$', '').trim()),
                            productId: productId,
                        });
                    });

                    const data = {
                        addressCode: addressCode,
                        paymentMethod: paymentMethod.value,
                        orderDetails: orderDetails,
                        subtotal: subtotal
                    };

                    if(paymentMethod.value == "CashOnDelivery"){
                        Swal.fire({
                                title: "Order Placed!",
                                text: "Your Order has been placed.",
                                icon: "success"
                              });
                    }

                    axios.post('/orderConfirm', data)
                        .then(function(response){
                            if (response.data.method) {
                                showOrderConfirmationModal(response.data);
                            }else if(response.data.razo){
                                const navv = document.getElementById("navv").style.display = 'block';       
                                
                        console.log("Reached here");
                        console.log("This is the data received", response.data);
                        
                        const orderData = response.data;
                        
                            const options = {
                                key: `${orderData.razoID}`,
                                amount: orderData.razo.amount,
                                currency: orderData.razo.currency,
                                name: 'Pillow Mart',
                                description: "Transaction",
                                order_id: orderData.razo.id,
                                handler: async function (response) {
                                    Swal.fire({
                                       title: "Order Placed!",
                                       text: "Your Order has been placed.",
                                       icon: "success"
                                    });
                                    console.log(response);

                                       axios.post('/razpayOrderPlace',orderData)

                                    showOrderConfirmationModal(orderData);
                                },
                                "prefill": {
                                     "name": "Mushrf",
                                     "email": "g@example.com",
                                     "contact": "9000090000"
                                },
                                theme: {
                                    color: '#B08EAD'
                                }
                            };
                            
                            const rzp = new Razorpay(options);

                            rzp.open();
                                           
                            }else{
                                notyf.error("Failed to place order. Please try again.");
                            }

                        })
                        .catch(function(error){
                            notyf.error("An error occurred. Please try again.");
                        });
                            }else{
                                const navv = document.getElementById("navv").style.display = 'block';
                            }
                     });

        }else{
            notyf.error("Select Payment Method");
        }
    }else{
        notyf.error("Select an address");
    }
}

function showOrderConfirmationModal(orderData){
    console.log("Order details modal")
    document.getElementById('orderNumber').innerText = orderData.orderNumber;
    document.getElementById('orderDate').innerText = orderData.orderDate;
    document.getElementById('orderTotal').innerText = `$${orderData.orderTotal}`;
    document.getElementById('paymentMethod').innerText = orderData.paymentMethod;

    document.getElementById('billingAddress').innerText = orderData.billingAddress.address;
    document.getElementById('billingCity').innerText = orderData.billingAddress.town;
    document.getElementById('billingPhone').innerText = orderData.billingAddress.phone;
    document.getElementById('billingPostcode').innerText = orderData.billingAddress.pincode;

    const orderDetailsTableBody = document.getElementById('orderDetailsTableBody');
    orderDetailsTableBody.innerHTML = '';

    orderData.orderDetails.forEach(detail => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <th colspan="2"><span>${detail.productTitle}</span></th>
            <th>x${detail.quantity}</th>
            <th><span>$${detail.total}</span></th>
        `;
        orderDetailsTableBody.appendChild(row);
    });

    document.getElementById('modalSubtotal').innerText = `$${orderData.subtotal}`;

    const modal = new bootstrap.Modal(document.getElementById('orderConfirmationModal'), {
        backdrop: 'static',
        keyboard: false
    });
    const navv = document.getElementById("navv").style.display = 'none';
    
    modal.show();
}

    document.addEventListener('DOMContentLoaded', function() {
    const infoHeaders = document.querySelectorAll('.Check-info-header');

    for (let i = 0; i < infoHeaders.length; i++) {
        const infoHeader = infoHeaders[i];
        const infoContent = infoHeader.nextElementSibling;
        const arrow = infoHeader.querySelector('.Check-arrow');

        infoHeader.addEventListener('click', function() {
            if (infoContent.style.display === 'block') {
                infoContent.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            } else {
                infoContent.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            }
        });

        const radioButton = infoHeader.querySelector('input[type="radio"]');
        radioButton.addEventListener('click', function(event) {
            event.stopPropagation();
        });
    }
});

// adding new address for user
  document.getElementById("saveAddressButton").addEventListener('click',function(event){
    event.preventDefault();

    function validateEmail(email) {
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

     return regex.test(email) ? false : true;
    }

   let data = {
    phone : document.getElementById('phone').value,
   name : document.getElementById('name').value,
   Bname : document.getElementById('Bname').value,
   email : document.getElementById('email').value,
   address : document.getElementById('address').value,
   town : document.getElementById('city').value,
   pincode : document.getElementById('pincode').value,
              }

     if(data.name == '' ||data.Bname == '' ||data.phone == '' ||data.email == '' ||data.address == '' ||data.city == '' ||data.pincode == ''){
        notyf.error("Fill the form")
     }else{
        if(data.phone.length !== 10){
            notyf.error("Enter a Valid Phone Number")
        }else if(validateEmail(data.email)){
            notyf.error("Enter a Valid Email")
        }else if(data.pincode.length !== 6){
            notyf.error("Enter a Valid Pincode")
        }else{

       axios.post("/user/addressAddCheckout",data)
       .then(function(response){
           if(response.data.doneMessage){
             alert("Created Successfully Now Select the Available address")       
             window.location.reload()          
           }else if(response.data.message){
             notyf.error("Failed try again")
           }
       }).catch(function(error){
        console.error('Error:', error);
      });  
        }
     }
   

  })  

  document.getElementById("closeMOdal").addEventListener('click',function(){
    const navv = document.getElementById("navv").style.display = 'block';
        window.location.href="/user/order"
  })

</script>
<!-- jquery plugins here-->
<script src="js/jquery-1.12.1.min.js"></script>
<!-- popper js -->
<script src="js/popper.min.js"></script>
<!-- bootstrap js -->
<script src="js/bootstrap.min.js"></script>
<!-- easing js -->
<script src="js/jquery.magnific-popup.js"></script>
<!-- swiper js -->
<script src="js/swiper.min.js"></script>
<!-- swiper js -->
<script src="js/mixitup.min.js"></script>
<!-- particles js -->
<script src="js/owl.carousel.min.js"></script>
<script src="js/jquery.nice-select.min.js"></script>
<!-- slick js -->
<script src="js/slick.min.js"></script>
<script src="js/jquery.counterup.min.js"></script>
<script src="js/waypoints.min.js"></script>
<script src="js/contact.js"></script>
<script src="js/jquery.ajaxchimp.min.js"></script>
<script src="js/jquery.form.js"></script>
<script src="js/jquery.validate.min.js"></script>
<script src="js/mail-script.js"></script>
<!-- custom js -->
<script src="js/custom.js"></script>
</body>
</html>
